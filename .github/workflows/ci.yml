name: CI Tests

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
    - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v5
      
    # Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: ğŸ Python ${{ matrix.python-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    # ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk
        
    # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ğŸ“š ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    # ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    - name: ğŸ¨ ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== flake8 ãƒã‚§ãƒƒã‚¯ ==="
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        echo "=== black ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ ==="
        black --check . || echo "black formatting issues found"
        echo "=== isort ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºãƒã‚§ãƒƒã‚¯ ==="
        isort --check-only . || echo "isort issues found"
      continue-on-error: true
        
    # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - name: ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "=== åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ==="
        python -m unittest tests.test_config -v
        
        echo "=== GUIæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ==="
        python -m unittest tests.test_gui -v
        
        echo "=== PDFå‡¦ç†ãƒ†ã‚¹ãƒˆ ==="
        python -m unittest tests.test_pdf_processing -v
        
    # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
      run: |
        echo "=== ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šå®Ÿè¡Œ ==="
        coverage run -m pytest tests/ || echo "pytestå®Ÿè¡Œå®Œäº†"
        coverage report
        coverage xml
      continue-on-error: true
        
    # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: ğŸ“¤ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    # æˆæœç‰©ä¿å­˜
    - name: ğŸ’¾ ãƒ†ã‚¹ãƒˆçµæœä¿å­˜
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-python-${{ matrix.python-version }}
        path: |
          coverage.xml
          .coverage
        retention-days: 30

  lint-and-security:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v5
      
    - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“š Lintingä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy bandit safety
        
    - name: ğŸ” è©³ç´°ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== flake8 è©³ç´°ãƒã‚§ãƒƒã‚¯ ==="
        flake8 . --max-line-length=88 --extend-ignore=E203,W503 --statistics
        
        echo "=== å‹ãƒã‚§ãƒƒã‚¯ (mypy) ==="
        mypy --ignore-missing-imports . || echo "å‹ãƒã‚§ãƒƒã‚¯å®Œäº†"
        
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (bandit) ==="
        bandit -r . -f json -o bandit-report.json || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
        
        echo "=== ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (safety) ==="
        safety check || echo "ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å®Œäº†"
      continue-on-error: true
      
    - name: ğŸ“¤ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
        retention-days: 30

  build-test:
    name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v5
      
    - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk
        
    - name: ğŸ“š ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: |
        echo "=== GUIèµ·å‹•ãƒ†ã‚¹ãƒˆ ==="
        timeout 10 python gui_main.py || echo "GUIèµ·å‹•ãƒ†ã‚¹ãƒˆå®Œäº†"
        
        echo "=== Consoleèµ·å‹•ãƒ†ã‚¹ãƒˆ ==="
        timeout 10 python process_enhanced.py || echo "Consoleèµ·å‹•ãƒ†ã‚¹ãƒˆå®Œäº†"
        
        echo "=== åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ==="
        python test_basic.py || echo "åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†"
      continue-on-error: true

  cross-platform-test:
    name: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v5
      
    - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ”§ OSåˆ¥ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      shell: bash
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y python3-tk
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          echo "macOS: tkinter ã¯ Python ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "Windows: tkinter ã¯ Python ã«å«ã¾ã‚Œã¦ã„ã¾ã™"
        fi
        
    - name: ğŸ“š æœ€å°ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install reportlab pillow
        # PyMuPDF ã¯é‡ã„ã®ã§åŸºæœ¬ãƒ†ã‚¹ãƒˆã§ã¯ã‚¹ã‚­ãƒƒãƒ—
        
    - name: ğŸ§ª ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
      run: |
        echo "=== OSæƒ…å ± ==="
        python -c "import os, sys; print(f'OS: {os.name}, Platform: {sys.platform}')"
        
        echo "=== tkinter å¯ç”¨æ€§ãƒ†ã‚¹ãƒˆ ==="
        python -c "import tkinter; print('tkinter OK')" || echo "tkinter not available"
        
        echo "=== åŸºæœ¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ ==="
        python -c "import json, pathlib, tempfile; print('Basic imports OK')"
        
        echo "=== è¨­å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="
        python -m unittest tests.test_config.TestCrossPlatformFeatures -v
      continue-on-error: true